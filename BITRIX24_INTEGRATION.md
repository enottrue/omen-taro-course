# Интеграция с Битрикс24

## Обзор

Проект интегрирован с CRM Битрикс24 для автоматического создания контактов и сделок при регистрации пользователей.

## Функциональность

### 1. Автоматическое создание контактов и сделок
- При регистрации пользователя автоматически создается контакт в Битрикс24
- Создается сделка с товаром ID 1777
- Все цены указываются в USD
- Передаются UTM метки для аналитики

### 2. Сохранение ID из Битрикс24
- В базе данных сохраняются ID контакта и сделки из Битрикс24
- Поля: `bitrix24ContactId` и `bitrix24DealId`

### 3. Управление статусом оплаты
- Добавлено поле `isPaid` для отслеживания статуса оплаты
- API endpoint для обновления статуса оплаты
- Компонент для управления статусом в интерфейсе

## Структура базы данных

### Таблица User
```sql
-- Новые поля
isPaid BOOLEAN DEFAULT false
bitrix24ContactId INTEGER
bitrix24DealId INTEGER
```

## API Endpoints

### 1. Создание сделки в Битрикс24
```
POST /api/bitrix24/create-deal
```

### 2. Обновление статуса оплаты
```
POST /api/users/update-payment
Body: { userId: number, isPaid: boolean }
```

### 3. Получение информации о пользователе
```
GET /api/users/[id]
```

## Компоненты

### 1. PaymentStatus
Компонент для управления статусом оплаты пользователя.

### 2. UserInfo
Компонент для отображения информации о пользователе, включая ID из Битрикс24.

## Утилиты

### 1. bitrix24.ts
- `createDealOnRegistration()` - создание сделки при регистрации
- `checkContactExists()` - проверка существования контакта
- `createContact()` - создание контакта
- `getProductInfo()` - получение информации о товаре
- `createDeal()` - создание сделки
- `addProductToDeal()` - добавление товара к сделке

### 2. utmUtils.ts
- `getUtmDataFromCookies()` - получение UTM данных из cookies
- `getUtmForBitrix24()` - форматирование UTM для Битрикс24

## Конфигурация

### Переменные окружения
```env
BITRIX24_WEBHOOK_URL=https://omen-taro.bitrix24.ru/rest/1/your-webhook-key/
```

## Тестирование

### Тестовая страница
```
http://localhost:3000/bitrix24-test
```

Страница включает:
- Тест интеграции с Битрикс24
- Отображение информации о пользователе
- Управление статусом оплаты

## Процесс регистрации

1. Пользователь заполняет форму регистрации
2. Создается запись в базе данных
3. Вызывается API для создания сделки в Битрикс24
4. Сохраняются ID контакта и сделки в базе данных
5. Пользователь получает доступ к системе

## Мониторинг

### Логирование
- Все операции с Битрикс24 логируются в консоль
- Ошибки не прерывают процесс регистрации
- Успешные операции обновляют пользователя в базе данных

### Отладка
- Используйте тестовую страницу для проверки интеграции
- Проверяйте консоль браузера для логов
- Убедитесь, что сделки создаются в Битрикс24

## Безопасность

- Webhook URL хранится в переменных окружения
- Ошибки интеграции не влияют на основную функциональность
- Валидация данных на всех уровнях 