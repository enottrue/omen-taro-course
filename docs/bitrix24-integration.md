# Интеграция с Битрикс24

## Обзор

Данная интеграция позволяет автоматически создавать сделки в Битрикс24 при регистрации пользователей на сайте. Интеграция включает в себя:

- Создание контактов в Битрикс24
- Создание сделок с привязкой к контактам
- Добавление товаров к сделкам
- Отслеживание UTM меток
- Обработка ошибок без прерывания регистрации пользователя

## Файлы интеграции

### Основные файлы:

1. **`src/utils/bitrix24.ts`** - Основные функции для работы с API Битрикс24
2. **`src/utils/utmUtils.ts`** - Утилиты для работы с UTM метками
3. **`src/components/UtmInitializer.tsx`** - Компонент для инициализации UTM меток
4. **`pages/api/bitrix24/create-deal.ts`** - API endpoint для создания сделок
5. **`src/hooks/useSubmit.tsx`** - Обновленный хук для регистрации с интеграцией Битрикс24

## Настройка

### 1. Конфигурация webhook URL

В файле `src/utils/bitrix24.ts` установите правильный webhook URL:

```typescript
const BITRIX24_WEBHOOK_URL = 'https://crm.taroirena.com/rest/49468/d9cuna1b89mnipbq/';
```

### 2. Настройка ответственного менеджера

В функциях создания контактов и сделок установите правильный ID ответственного менеджера:

```typescript
ASSIGNED_BY_ID: 30902, // Замените на ID вашего менеджера
```

### 3. Настройка категории сделок

Установите правильную категорию для сделок:

```typescript
CATEGORY_ID: 11, // Замените на ID нужной категории
```

## Функциональность

### Создание контактов

Функция `createContact()` создает новый контакт в Битрикс24 с указанными данными:

```typescript
const contactId = await createContact({
  name: 'Иван',
  lastName: 'Иванов',
  phone: '+7 (999) 123-45-67',
  email: 'ivan@example.com'
});
```

### Проверка существования контакта

Функция `checkContactExists()` проверяет, существует ли контакт с указанным телефоном или email:

```typescript
const existingContactId = await checkContactExists(phone, email);
```

### Создание сделок

Функция `createDeal()` создает новую сделку в Битрикс24:

```typescript
const dealId = await createDeal({
  title: 'Регистрация пользователя',
  name: 'Иван Иванов',
  phone: '+7 (999) 123-45-67',
  email: 'ivan@example.com',
  comments: 'Комментарий к сделке',
  contactId: 123,
  utmData: {
    UTM_SOURCE: 'google',
    UTM_MEDIUM: 'cpc',
    UTM_CAMPAIGN: 'summer2024'
  }
});
```

### Добавление товаров к сделке

Функция `addProductsToDeal()` добавляет товары к существующей сделке:

```typescript
await addProductsToDeal(dealId, productId, price);
```

### Основная функция регистрации

Функция `createDealOnRegistration()` выполняет полный цикл создания сделки при регистрации:

1. Проверяет существование контакта
2. Создает новый контакт при необходимости
3. Получает информацию о продукте (если указан)
4. Создает сделку
5. Добавляет товары к сделке

## UTM метки

### Автоматическое отслеживание

Система автоматически отслеживает UTM метки из URL параметров и сохраняет их в cookies:

- `utm_source` - источник трафика
- `utm_medium` - тип трафика
- `utm_campaign` - название кампании
- `utm_content` - содержимое
- `utm_term` - ключевые слова

### Использование UTM меток

UTM метки автоматически передаются в Битрикс24 при создании сделок:

```typescript
const utmData = getUtmForBitrix24();
// Передается в createDealOnRegistration()
```

## Обработка ошибок

Интеграция настроена так, чтобы ошибки в Битрикс24 не прерывали процесс регистрации пользователя:

```typescript
try {
  const bitrixResult = await createDealOnRegistration(userData);
  if (bitrixResult.success) {
    console.log('Сделка создана:', bitrixResult.dealId);
  } else {
    console.error('Ошибка создания сделки:', bitrixResult.error);
  }
} catch (error) {
  console.error('Ошибка интеграции с Битрикс24:', error);
  // Регистрация пользователя продолжается
}
```

## API Endpoint

### POST /api/bitrix24/create-deal

Создает сделку в Битрикс24 через API endpoint.

**Параметры запроса:**
```json
{
  "name": "Иван Иванов",
  "email": "ivan@example.com",
  "phone": "+7 (999) 123-45-67",
  "city": "Москва",
  "productId": "123",
  "comments": "Комментарий",
  "utmData": {
    "UTM_SOURCE": "google",
    "UTM_MEDIUM": "cpc"
  },
  "dopContact": "Дополнительный контакт",
  "sourceInc": "Источник",
  "telegram": "@username",
  "term": "Ключевые слова"
}
```

**Ответ:**
```json
{
  "success": true,
  "dealId": 12345,
  "contactId": 67890,
  "productName": "Название продукта",
  "productPrice": 1000
}
```

## Логирование

Все операции с Битрикс24 логируются в консоль:

- Успешное создание контактов и сделок
- Ошибки при создании
- Информация о продуктах
- UTM метки

## Тестирование

Для тестирования интеграции:

1. Зарегистрируйте нового пользователя
2. Проверьте логи в консоли браузера
3. Убедитесь, что сделка создана в Битрикс24
4. Проверьте, что UTM метки переданы корректно

## Безопасность

- Webhook URL должен быть защищен
- Все запросы к Битрикс24 выполняются через HTTPS
- Ошибки не раскрывают чувствительную информацию
- Интеграция не прерывает основной функционал приложения

## Поддержка

При возникновении проблем:

1. Проверьте логи в консоли браузера
2. Убедитесь в правильности webhook URL
3. Проверьте права доступа в Битрикс24
4. Убедитесь в корректности ID менеджера и категории 